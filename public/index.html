<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Head Tracker + Tasks (Mock Mode)</title>
  <style>
    body { margin: 0; overflow: hidden; background: #000; color: white; }
    #container { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
    #video {
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      position: absolute;
      top: 0; left: 0;
      z-index: 0;
    }
    .balloon {
      position: absolute;
      background: rgba(255,255,255,0.9);
      color: #000;
      border-radius: 12px;
      padding: 6px 10px;
      font-family: sans-serif;
      font-size: 14px;
      transform: translate(-50%, -120%);
      pointer-events: none;
      min-width: 140px;
      text-align: center;
    }
    #startBtn {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 12px 24px;
      font-size: 16px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="container">
    <video id="video" autoplay playsinline muted></video>
    <button id="startBtn">ðŸŽ¥ Start Camera</button>
  </div>

  <script type="module">
    import { FaceMesh } from "https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh";
    import { Camera } from "https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils";

    const video = document.getElementById("video");
    const container = document.getElementById("container");
    const startBtn = document.getElementById("startBtn");

    async function getTasks() {
      try {
        const res = await fetch("/tasks");
        return await res.json();
      } catch (e) {
        console.warn("âš ï¸ Could not load /tasks, using mock data.");
        return [
          { name: "Alice", task: "Design homepage", status: "In Progress" },
          { name: "Bob", task: "Fix login bug", status: "Todo" },
          { name: "Clara", task: "Write docs", status: "Done" },
          { name: "David", task: "Review pull request", status: "In Review" },
          { name: "Eve", task: "Prepare presentation", status: "Todo" }
        ];
      }
    }

    let tasks = [];

    startBtn.onclick = async () => {
      startBtn.remove();
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        tasks = await getTasks();
        startTracking();
      } catch (err) {
        alert("Camera access denied or unavailable: " + err.message);
        console.error(err);
      }
    };

    function startTracking() {
      const faceMesh = new FaceMesh({
        locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
      });
      faceMesh.setOptions({
        maxNumFaces: 5,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
      });

      faceMesh.onResults(results => {
        container.querySelectorAll(".balloon").forEach(b => b.remove());
        if (!results.multiFaceLandmarks) return;

        results.multiFaceLandmarks.forEach((lm, i) => {
          const nose = lm[1]; // near face center
          const x = nose.x * window.innerWidth;
          const y = nose.y * window.innerHeight - 80;

          const div = document.createElement("div");
          div.className = "balloon";

          const person = tasks[i % tasks.length];
          div.innerHTML = `<strong>${person.name}</strong><br>${person.task}<br><em>${person.status}</em>`;

          div.style.left = `${x}px`;
          div.style.top = `${y}px`;

          container.appendChild(div);
        });
      });

      const camera = new Camera(video, {
        onFrame: async () => { await faceMesh.send({ image: video }); },
        width: 1280,
        height: 720
      });
      camera.start();
    }
  </script>
</body>
</html>
